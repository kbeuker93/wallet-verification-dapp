<!DOCTYPE html>
<html>
<head>
  <title>Wallet Verification</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      max-width: 600px;
      margin: auto;
      text-align: center;
    }
    button {
      padding: 15px 25px;
      font-size: 16px;
      cursor: pointer;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin-top: 15px;
      font-size: 14px;
    }
    #instructions {
      margin-top: 20px;
      font-size: 14px;
      text-align: left;
    }
  </style>
</head>
<body>
  <h2>Wallet Verification</h2>
  <p>Click the button below to connect your Phantom wallet and sign the verification message.</p>
  <button id="connect">Connect Phantom & Sign</button>

  <div id="result" style="display:none;">
    <h3>âœ… Wallet Signed Successfully!</h3>
    <p>Copy the signature below and send it to the Telegram bot using the <code>/confirm</code> command:</p>
    <textarea id="signature" readonly></textarea>
    <div id="instructions">
      Example command:<br>
      <code>/confirm &lt;your_wallet_address&gt; &lt;signed_message_here&gt;</code>
    </div>
  </div>

  <!-- Include bs58 library to convert signature to Base58 -->
  <script src="https://cdn.jsdelivr.net/npm/bs58@5.0.0/dist/bs58.min.js"></script>

  <script>
    const connectButton = document.getElementById("connect");
    const resultDiv = document.getElementById("result");
    const signatureBox = document.getElementById("signature");

    connectButton.onclick = async () => {
      if (!window.solana || !window.solana.isPhantom) {
        alert("Phantom Wallet is required! Please install Phantom from https://phantom.app/");
        return;
      }

      // Connect wallet
      const resp = await window.solana.connect();
      const walletAddress = resp.publicKey.toString();

      // Read nonce and user ID from query parameters
      const urlParams = new URLSearchParams(window.location.search);
      const nonce = urlParams.get("nonce");
      const userId = urlParams.get("user");

      if (!nonce) {
        alert("Nonce missing in URL!");
        return;
      }

      // Construct the exact message for verification
      const message = `Verify wallet ${walletAddress} nonce ${nonce} at ${Date.now()}`;

      // Encode and sign the message
      const encodedMessage = new TextEncoder().encode(message);
      const signedMessage = await window.solana.signMessage(encodedMessage, "utf8");

      // Convert signature to Base58
      const signatureBase58 = bs58.encode(signedMessage.signature);

      // Show result div
      resultDiv.style.display = "block";
      signatureBox.value = signatureBase58;

      // Optional: scroll to signature box automatically
      signatureBox.scrollIntoView({ behavior: "smooth" });
    };
  </script>
</body>
</html>
