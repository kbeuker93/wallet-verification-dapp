<script>
  const params = new URLSearchParams(window.location.search);
  const nonce = params.get("nonce");
  const userId = params.get("user");
  const phantomSig = params.get("signature");
  const phantomPubkey = params.get("publicKey");

  const verifyBtn = document.getElementById("verifyBtn");
  const statusDiv = document.getElementById("status");
  const BACKEND_URL = "https://wallet-verification-backend.onrender.com";

  // üì± Mobile auto-verify after Phantom redirect
  if (phantomSig && phantomPubkey) {
    verifyBtn.disabled = true;
    verifyBtn.innerText = "Verifying‚Ä¶";
    statusDiv.innerText = "üîê Verifying signature‚Ä¶";

    fetch(`${BACKEND_URL}/verify-signature`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        wallet: phantomPubkey,
        nonce,
        user: userId,
        signature: phantomSig
      })
    })
      .then(r => r.json())
      .then(() => {
        verifyBtn.innerText = "Verified ‚úì";
        statusDiv.innerHTML =
          "<p class='text-green-400'>‚úÖ Wallet verified. Return to Telegram.</p>";
      })
      .catch(err => {
        statusDiv.innerHTML =
          `<p class='text-red-400'>‚ùå ${err.message}</p>`;
      });

    return;
  }

  // üñ• Desktop manual signing
  verifyBtn.onclick = async () => {
    try {
      if (!window.solana || !window.solana.isPhantom) {
        alert("Phantom extension required.");
        return;
      }

      verifyBtn.disabled = true;
      statusDiv.innerText = "Connecting‚Ä¶";

      const resp = await window.solana.connect();
      const wallet = resp.publicKey.toString();

      const msg = `Verify wallet ownership for Telegram\nNonce: ${nonce}`;
      const signed = await window.solana.signMessage(
        new TextEncoder().encode(msg),
        "utf8"
      );

      const sig = base58Encode(signed.signature);

      await fetch(`${BACKEND_URL}/verify-signature`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          wallet,
          nonce,
          user: userId,
          signature: sig
        })
      });

      verifyBtn.innerText = "Verified ‚úì";
      statusDiv.innerHTML =
        "<p class='text-green-400'>‚úÖ Wallet verified. Return to Telegram.</p>";

    } catch (err) {
      verifyBtn.disabled = false;
      verifyBtn.innerText = "Connect Phantom & Verify";
      statusDiv.innerHTML =
        `<p class='text-red-400'>‚ùå ${err.message}</p>`;
    }
  };
</script>
